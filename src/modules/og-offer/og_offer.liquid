{% comment %}
NOTE: this is a customized version of the Ordergroove snippets. Modified
areas are indicated with "OG-INTEGRATION"
{% endcomment %}

<!-- TODO-ORDERGROOVE: remove me -->
<h1>og_offer</h1>

{% comment %}
OG-INTEGRATION: This code has been moved to the `.mounted` event on the vue module
<script>
  var productIds = [];
  {% for item in cart.items %}
  productIds.push("{{item.variant_id}}");
  {% endfor %}
  window.order_line_items = productIds;
</script>
{% endcomment %}

{% comment %}
OF-INTEGRATION: Create an array of product ids to pass to the module
{% endcomment }
{% assign og_product_ids = cart.items | map: "variant_id" | join: "," %}

<div is="og-offer" inline-template product-ids-string="{{og_product_ids}}">
  <div data-module="og-offer">
  <!-- TODO-ORDERGROOVE: remove me -->
  <h1>og-offer</h1>
{% if selected_variant %}
  {% assign product = selected_variant %}
{% elsif line_item %}
  {% assign product = line_item %}
{% endif %}
{% if product %}
  {% if type == 'cart' %}
    {% assign cart_type = true %}
    {% unless location %}
      {% assign location = 'cart' %}
    {% endunless %}
  {% endif %}
  {% if cart_type %}
    {% for selling_plan_allocation in product.variant.selling_plan_allocations %}
      {% assign frequency = selling_plan_allocation.selling_plan.options[0].value | split: " " %}
      {% if frequency.size > 1 %}
        {% assign frequency_period = frequency[1] | replace: "(s)", "" | replace: "s", "" | upcase | replace: "DAY", "1" | replace: "WEEK", "2" | replace: "MONTH", "3" %}
        {% assign frequency = frequency[0] |append: "_" | append: frequency_period %}
      {% elsif frequency.size == 1 %}
        {% assign frequency_period = frequency[0] | upcase | replace: "DAY", "1" | replace: "WEEK", "2" | replace: "MONTH", "3" %}
        {% assign frequency = "1" |append: "_" | append: frequency_period %}
      {% endif %}
      <span id="og-selling-plan-map-{{product.variant_id}}-{{frequency}}" selling-plan-id="{{selling_plan_allocation.selling_plan.id}}" style="display:none !important;"></span>
    {% endfor %}
    <og-offer product="{{ product.variant_id }}" data-line-id="{{ product.key }}" data-line-qty="{{ product.quantity }}" location="{{ location }}" os-version="1"></og-offer>
  {% else %}
    {%- for variant in product.product.variants -%}
      {% for selling_plan_allocation in variant.selling_plan_allocations %}
        {% assign frequency = selling_plan_allocation.selling_plan.options[0].value | split: " " %}
        {% if frequency.size > 1 %}
          {% assign frequency_period = frequency[1] | replace: "(s)", "" | replace: "s", "" | upcase | replace: "DAY", "1" | replace: "WEEK", "2" | replace: "MONTH", "3" %}
          {% assign frequency = frequency[0] |append: "_" | append: frequency_period %}
        {% elsif frequency.size == 1 %}
          {% assign frequency_period = frequency[0] | upcase | replace: "DAY", "1" | replace: "WEEK", "2" | replace: "MONTH", "3" %}
          {% assign frequency = "1" |append: "_" | append: frequency_period %}
        {% endif %}
        <span id="og-selling-plan-map-{{variant.id}}-{{frequency}}" selling-plan-id="{{selling_plan_allocation.selling_plan.id}}" style="display:none !important;"></span>
      {% endfor %}
    {%- endfor -%}
    <og-offer product="{{ product.id }}" location="{{location}}" os-version="1"></og-offer>
  {% endif %}
{% else %}
  <!-- TODO-ORDERGROOVE: issue warning when product is missing -->
  <!-- <script>console.error("ordergroove_offer snippet requires a product")</script> -->
{% endif %}
  </div>
</div>
